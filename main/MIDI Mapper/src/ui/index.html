<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIDITypist</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    /* â”€â”€ Reset & Base â”€â”€ */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg-primary: rgba(20, 20, 22, 0.72);
      --bg-card: rgba(30, 30, 32, 0.55);
      --bg-card-hover: rgba(40, 40, 42, 0.6);
      --bg-input: rgba(255, 255, 255, 0.05);
      --border-card: rgba(255, 255, 255, 0.1);
      --border-subtle: rgba(255, 255, 255, 0.04);
      --accent: #0a84ff;
      --accent-hover: #409cff;
      --accent-glow: rgba(10, 132, 255, 0.3);
      --green: #30d158;
      --red: #ff453a;
      --orange: #ff9f0a;
      --text-primary: rgba(255, 255, 255, 0.92);
      --text-secondary: rgba(255, 255, 255, 0.55);
      --text-tertiary: rgba(255, 255, 255, 0.3);
      --shadow-card: 0 2px 20px rgba(0, 0, 0, 0.3), 0 0 1px rgba(255, 255, 255, 0.05) inset;
      --radius-lg: 14px;
      --radius-md: 10px;
      --radius-sm: 8px;
      --transition: 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    html,
    body {
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: transparent;
      color: var(--text-primary);
      overflow: hidden;
      user-select: none;
      -webkit-font-smoothing: antialiased;
    }

    body {
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      background: var(--bg-primary);
    }

    /* â”€â”€ Title Bar â”€â”€ */
    .titlebar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px 12px;
      -webkit-app-region: drag;
      flex-shrink: 0;
    }

    .titlebar h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.3px;
      background: linear-gradient(135deg, #fff 0%, rgba(255, 255, 255, 0.7) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .titlebar .subtitle {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 1.2px;
      margin-left: 12px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--red);
      box-shadow: 0 0 6px var(--red);
      transition: all var(--transition);
    }

    .status-dot.connected {
      background: var(--green);
      box-shadow: 0 0 8px var(--green);
    }

    /* â”€â”€ Toolbar â”€â”€ */
    .toolbar {
      display: flex;
      gap: 8px;
      padding: 0 24px 16px;
      flex-shrink: 0;
      align-items: center;
    }

    .toolbar select {
      flex: 1;
      max-width: 240px;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-card);
      background: var(--bg-input);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      outline: none;
      cursor: pointer;
      transition: all var(--transition);
      -webkit-app-region: no-drag;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='rgba(255,255,255,0.4)' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 28px;
    }

    .toolbar select:hover {
      border-color: rgba(255, 255, 255, 0.2);
    }

    .toolbar select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .btn {
      padding: 6px 14px;
      border-radius: var(--radius-sm);
      border: none;
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
      -webkit-app-region: no-drag;
      outline: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      box-shadow: 0 1px 8px var(--accent-glow);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 3px 12px var(--accent-glow);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--bg-input);
      color: var(--text-primary);
      border: 1px solid var(--border-card);
    }

    .btn-secondary:hover {
      background: var(--bg-card-hover);
      border-color: rgba(255, 255, 255, 0.12);
    }

    .btn-danger {
      background: rgba(255, 69, 58, 0.15);
      color: var(--red);
      border: 1px solid rgba(255, 69, 58, 0.2);
    }

    .btn-danger:hover {
      background: rgba(255, 69, 58, 0.25);
    }

    .btn-learn {
      background: linear-gradient(135deg, #ff9f0a 0%, #ff6723 100%);
      color: white;
      box-shadow: 0 1px 8px rgba(255, 159, 10, 0.3);
    }

    .btn-learn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 12px rgba(255, 159, 10, 0.4);
    }

    .btn-learn.active {
      animation: pulse-learn 1.5s ease-in-out infinite;
    }

    @keyframes pulse-learn {

      0%,
      100% {
        box-shadow: 0 0 8px rgba(255, 159, 10, 0.3);
      }

      50% {
        box-shadow: 0 0 20px rgba(255, 159, 10, 0.6);
      }
    }

    /* â”€â”€ Main Content â”€â”€ */
    .content {
      display: flex;
      gap: 12px;
      padding: 0 24px;
      flex: 1;
      min-height: 0;
    }

    .card {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-card);
      border: 1px solid var(--border-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-card);
      overflow: hidden;
      backdrop-filter: blur(20px);
      transition: border-color var(--transition);
    }

    .card:hover {
      border-color: rgba(255, 255, 255, 0.12);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px 10px;
      border-bottom: 1px solid var(--border-subtle);
      flex-shrink: 0;
    }

    .card-header h2 {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: var(--text-secondary);
    }

    .card-header .badge {
      font-size: 10px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 10px;
      background: var(--bg-input);
      color: var(--text-secondary);
    }

    .card-body {
      flex: 1;
      overflow-y: auto;
      padding: 4px 0;
      min-height: 0;
    }

    /* Scrollbar */
    .card-body::-webkit-scrollbar {
      width: 6px;
    }

    .card-body::-webkit-scrollbar-track {
      background: transparent;
    }

    .card-body::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.12);
      border-radius: 3px;
    }

    .card-body::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Log Entries */
    .log-entry {
      padding: 6px 18px;
      font-size: 12px;
      font-weight: 400;
      color: var(--text-secondary);
      font-family: 'SF Mono', 'Menlo', 'Cascadia Code', monospace;
      line-height: 1.5;
      border-bottom: 1px solid transparent;
      transition: background var(--transition);
    }

    .log-entry:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .log-entry .timestamp {
      color: var(--text-tertiary);
      margin-right: 8px;
      font-size: 10px;
    }

    .log-entry.midi-note {
      color: var(--accent);
    }

    .log-entry.midi-cc {
      color: var(--orange);
    }

    .log-entry.system {
      color: var(--green);
    }

    /* Mapping List */
    .mapping-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 18px;
      border-bottom: 1px solid var(--border-subtle);
      transition: background var(--transition);
      cursor: default;
    }

    .mapping-item:hover {
      background: rgba(255, 255, 255, 0.04);
    }

    .mapping-item:last-child {
      border-bottom: none;
    }

    .mapping-item .source {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .mapping-item .arrow {
      color: var(--text-tertiary);
      margin: 0 10px;
      font-size: 12px;
    }

    .mapping-item .target {
      font-size: 13px;
      font-weight: 500;
      color: var(--accent);
    }

    .mapping-item .zone-badge {
      font-size: 9px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
      text-transform: uppercase;
    }

    .zone-badge.soft {
      background: rgba(48, 209, 88, 0.15);
      color: var(--green);
    }

    .zone-badge.hard {
      background: rgba(255, 69, 58, 0.15);
      color: var(--red);
    }

    .mapping-item .delete-btn {
      opacity: 0;
      background: none;
      border: none;
      color: var(--red);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      font-size: 14px;
      transition: all var(--transition);
      -webkit-app-region: no-drag;
    }

    .mapping-item:hover .delete-btn {
      opacity: 0.6;
    }

    .mapping-item .delete-btn:hover {
      opacity: 1;
      background: rgba(255, 69, 58, 0.12);
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-tertiary);
      font-size: 13px;
      gap: 8px;
    }

    .empty-state .icon {
      font-size: 32px;
      opacity: 0.4;
    }

    /* â”€â”€ Piano Roll â”€â”€ */
    .piano-roll {
      margin: 12px 24px;
      height: 56px;
      border-radius: var(--radius-md);
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid var(--border-card);
      display: flex;
      align-items: flex-end;
      overflow: hidden;
      flex-shrink: 0;
      position: relative;
    }

    .piano-key {
      flex: 1;
      min-width: 0;
      transition: background 0.08s ease;
      position: relative;
    }

    .piano-key.white {
      height: 100%;
      background: rgba(255, 255, 255, 0.06);
      border-right: 1px solid rgba(255, 255, 255, 0.03);
    }

    .piano-key.black {
      height: 65%;
      background: rgba(0, 0, 0, 0.4);
      border-right: 1px solid rgba(0, 0, 0, 0.2);
      z-index: 1;
    }

    .piano-key.active {
      background: var(--accent) !important;
      box-shadow: 0 0 16px var(--accent-glow), 0 0 4px var(--accent) inset;
    }

    /* â”€â”€ Status Bar â”€â”€ */
    .statusbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 24px 12px;
      flex-shrink: 0;
    }

    .statusbar .status-text {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-tertiary);
    }

    .statusbar .actions {
      display: flex;
      gap: 6px;
    }

    .mini-btn {
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid var(--border-card);
      background: transparent;
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
      -webkit-app-region: no-drag;
    }

    .statusbar .mini-btn:hover {
      background: var(--bg-input);
      color: var(--text-primary);
    }

    /* â”€â”€ Learning Overlay â”€â”€ */
    .learn-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 100;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
    }

    .learn-overlay.active {
      display: flex;
    }

    .learn-overlay .learn-prompt {
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      animation: fadeIn 0.3s ease;
    }

    .learn-overlay .learn-sub {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .learn-overlay .cancel-btn {
      margin-top: 12px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* â”€â”€ Animations â”€â”€ */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .log-entry {
      animation: slideIn 0.15s ease;
    }

    .mapping-item {
      animation: slideIn 0.2s ease;
    }

    /* â”€â”€ Settings View â”€â”€ */
    #settingsOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--bg-primary);
      backdrop-filter: blur(50px) saturate(200%);
      z-index: 200;
      padding: 40px;
      overflow-y: auto;
    }

    #settingsOverlay.active {
      display: flex;
      flex-direction: column;
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      max-width: 800px;
      width: 100%;
      margin-inline: auto;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      gap: 24px;
      max-width: 800px;
      width: 100%;
      margin-inline: auto;
    }

    .settings-section {
      background: var(--bg-card);
      border: 1px solid var(--border-card);
      border-radius: var(--radius-lg);
      padding: 20px;
    }

    .settings-section h3 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .setting-item:last-child {
      border-bottom: none;
    }

    .setting-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .setting-label {
      font-size: 14px;
      font-weight: 500;
    }

    .setting-desc {
      font-size: 12px;
      color: var(--text-tertiary);
    }

    /* Switch toggle */
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 22px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background-color: var(--bg-input);
      transition: .4s;
      border-radius: 22px;
      border: 1px solid var(--border-card);
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 1px;
      bottom: 1px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    input:checked+.slider {
      background-color: var(--accent);
      border-color: var(--accent);
    }

    input:checked+.slider:before {
      transform: translateX(18px);
    }

    .icon-svg {
      width: 16px;
      height: 16px;
      fill: none;
      stroke: currentColor;
      stroke-width: 2.5;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    /* â”€â”€ HUD Palette â”€â”€ */
    #hudOverlay {
      display: none;
      position: fixed;
      inset: 80px;
      background: rgba(10, 10, 12, 0.85);
      backdrop-filter: blur(40px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 32px;
      z-index: 300;
      padding: 40px;
      box-shadow: 0 40px 100px rgba(0, 0, 0, 0.8);
      flex-direction: column;
      align-items: center;
      justify-content: center;
      animation: hudFadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    #hudOverlay.active {
      display: flex;
    }

    @keyframes hudFadeIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(20px);
      }

      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .hud-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
      width: 100%;
      max-width: 1000px;
    }

    .hud-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      text-align: center;
      transition: all 0.2s ease;
    }

    .hud-item.active {
      background: var(--accent);
      border-color: var(--accent);
      transform: scale(1.05);
      box-shadow: 0 0 30px var(--accent-glow);
    }

    .hud-key-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .hud-action-label {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Context Band (v4.2) */
    .context-band {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 4px 16px;
      background: rgba(var(--accent-rgb), 0.1);
      border-bottom: 1px solid var(--border-card);
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
      animation: slideDown 0.3s ease;
    }

    .context-band .icon {
      opacity: 0.6;
      font-size: 14px;
    }

    .context-band .app-name {
      color: var(--accent);
      font-weight: 700;
    }

    .context-band .divider {
      width: 1px;
      height: 12px;
      background: var(--border-card);
      margin: 0 4px;
    }

    .context-band .window-title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0.8;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>

<body>

  <!-- Title Bar -->
  <div class="titlebar">
    <div style="display:flex;align-items:center;gap:12px;">
      <h1>MIDITypist</h1>
      <span class="subtitle">v3.1</span>
    </div>
    <div style="display:flex;align-items:center;gap:10px;">
      <span id="connectionLabel" style="font-size:11px;font-weight:500;color:var(--text-tertiary);">Disconnected</span>
      <div id="statusDot" class="status-dot"></div>
    </div>
  </div>

  <!-- Context Band (Signals) -->
  <div id="contextBand" class="context-band" style="display:none;">
    <span class="icon">ðŸŽ¯</span>
    <span id="contextApp" class="app-name">None</span>
    <div class="divider"></div>
    <span id="contextTitle" class="window-title">No foreground window</span>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div style="display:flex; gap:6px; flex:1; max-width:320px;">
      <select id="portSelect" style="flex:1;">
        <option value="">No MIDI ports found</option>
      </select>
      <button class="mini-btn" onclick="refreshPorts()" title="Refresh Ports" style="height:32px;">
        <svg class="icon-svg" viewBox="0 0 24 24">
          <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
          <path d="M3 3v5h5" />
          <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" />
          <path d="M16 16h5v5" />
        </svg>
      </button>
    </div>
    <button id="btnConnect" class="btn btn-primary" onclick="toggleConnect()">
      <svg class="icon-svg" viewBox="0 0 24 24">
        <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" />
      </svg>
      <span>Connect</span>
    </button>
    <button id="btnLearn" class="btn btn-learn" onclick="startLearn()">
      <svg class="icon-svg" viewBox="0 0 24 24">
        <path d="m6 14 3-3 5 5 1-1-5-5 3-3" />
      </svg>
      <span>Learn</span>
    </button>
    <button id="btnSettings" class="btn btn-secondary" onclick="toggleSettings()">
      <svg class="icon-svg" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="3" />
        <path
          d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
      </svg>
      <span>Settings</span>
    </button>
    <div style="flex:1;"></div>
    <button class="btn btn-secondary" onclick="saveProfile()" title="Save Profile">
      <svg class="icon-svg" viewBox="0 0 24 24">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
        <polyline points="17 21 17 13 7 13 7 21" />
        <polyline points="7 3 7 8 15 8" />
      </svg>
    </button>
    <button class="btn btn-secondary" onclick="loadProfile()" title="Load Profile">
      <svg class="icon-svg" viewBox="0 0 24 24">
        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
      </svg>
    </button>
    <button class="btn btn-secondary" onclick="showAbout()">
      <svg class="icon-svg" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" />
        <path d="M12 16v-4" />
        <path d="M12 8h.01" />
      </svg>
    </button>
  </div>

  <!-- Main Content -->
  <div class="content">
    <!-- Log Card -->
    <div class="card">
      <div class="card-header">
        <h2>System Log</h2>
        <div style="display:flex;gap:6px;">
          <span id="logCount" class="badge">0</span>
        </div>
      </div>
      <div id="logBody" class="card-body">
        <div class="empty-state">
          <svg class="icon-svg" style="width:32px; height:32px; opacity:0.4;" viewBox="0 0 24 24">
            <path d="M2 9h20" />
            <path d="M2 15h20" />
            <path d="M10 9v6" />
            <path d="M14 9v6" />
            <path d="M6 9v6" />
            <path d="M18 9v6" />
          </svg>
          <span>Connect a MIDI device to begin</span>
        </div>
      </div>
    </div>

    <!-- Mappings Card -->
    <div class="card">
      <div class="card-header">
        <h2>Key Mappings</h2>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="mini-btn" onclick="addMapping()" title="Add Mapping Manually">+</button>
          <span id="mapCount" class="badge">0</span>
        </div>
      </div>
      <div id="mapBody" class="card-body">
        <div class="empty-state">
          <svg class="icon-svg" style="width:32px; height:32px; opacity:0.4;" viewBox="0 0 24 24">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" />
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />
          </svg>
          <span>Use Learn to create mappings</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Piano Roll -->
  <div id="pianoRoll" class="piano-roll"></div>

  <!-- Status Bar -->
  <div class="statusbar">
    <span id="statusText" class="status-text">Ready</span>
    <div class="actions">
      <button class="mini-btn" onclick="clearLog()">Clear Log</button>
      <button class="mini-btn" onclick="clearMappings()">Clear Maps</button>
    </div>
  </div>

  <!-- Settings Overlay -->
  <div id="settingsOverlay">
    <div class="settings-header">
      <h1 style="font-size: 24px; font-weight: 700;">Settings</h1>
      <button class="btn btn-primary" onclick="toggleSettings()">Done</button>
    </div>

    <div class="settings-grid">
      <div class="settings-section">
        <h3>General</h3>
        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">Auto-Reconnect</span>
            <span class="setting-desc">Automatically connect to the last used MIDI port on startup.</span>
          </div>
          <label class="switch">
            <input type="checkbox" id="settingAutoReconnect" onchange="updateSettings()">
            <span class="slider"></span>
          </label>
        </div>
        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">Minimize to Tray</span>
            <span class="setting-desc">Close button will hide the app instead of exiting.</span>
          </div>
          <label class="switch">
            <input type="checkbox" id="settingMinimizeToTray" checked onchange="updateSettings()">
            <span class="slider"></span>
          </label>
        </div>
      </div> <!-- End General Section -->

      <div class="settings-section">
        <h3>Smart Context</h3>
        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">App Auto-Switching</span>
            <span class="setting-desc">Automatically switch profiles based on the active application.</span>
          </div>
          <label class="switch">
            <input type="checkbox" id="settingAppSwitching" onchange="updateSettings()">
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div class="settings-section">
        <h3>MIDI Engine</h3>
        <div class="setting-item">
          <div class="setting-info">
            <span class="setting-label">Velocity Zones</span>
            <span class="setting-desc">Trigger different actions based on strike force.</span>
          </div>
          <label class="switch">
            <input type="checkbox" id="settingVelocityZones" onchange="updateSettings()" checked>
            <span class="slider"></span>
          </label>
        </div>
        <div class="divider"
          style="margin-top:16px; font-size:10px; opacity:0.3; text-transform:uppercase; letter-spacing:1px; border-top:1px solid rgba(255,255,255,0.05); padding-top:10px;">
          AI Integration</div>
        <div class="setting-item">
          <div class="setting-info" style="width:100%;">
            <span class="setting-label">OpenAI API Key</span>
            <input type="password" id="inputApiKey" placeholder="sk-..." onchange="updateSettings()"
              style="margin-top:8px; width:100%; background:var(--bg-input); border:1px solid var(--border-card); color:white; border-radius:6px; padding:6px; font-family:inherit;">
          </div>
        </div>
        <div class="setting-item">
          <div class="setting-info" style="width:100%;">
            <span class="setting-label">Global Prompt Mask</span>
            <textarea id="inputAiGlobal" onchange="updateSettings()"
              style="margin-top:8px; width:100%; height:60px; background:var(--bg-input); border:1px solid var(--border-card); color:white; border-radius:8px; padding:8px; font-family:inherit; font-size:11px;">You are a desktop automation assistant. Perform the following task briefly: {prompt}</textarea>
          </div>
        </div>
      </div>
    </div> <!-- End settings-grid -->
    <div style="margin-top: 40px; text-align: center; color: var(--text-tertiary); font-size: 12px;">
      MIDITypist v4.1 &bull; (C) 2026
    </div>
  </div> <!-- End settingsOverlay -->

  <!-- HUD Overlay -->
  <div id="hudOverlay">
    <div style="margin-bottom: 40px; text-align: center;">
      <h2 style="font-size: 14px; text-transform: uppercase; letter-spacing: 2px; color: var(--accent);">Active Palette
      </h2>
      <h1 id="hudTitle" style="font-size: 32px; font-weight: 800; margin-top: 8px;">Default Layer</h1>
    </div>
    <div id="hudGrid" class="hud-grid">
      <!-- Mapped actions will appear here -->
    </div>
  </div>

  <!-- Learning Overlay -->
  <div id="learnOverlay" class="learn-overlay">
    <div id="learnPrompt" class="learn-prompt">Press a MIDI note or CC...</div>
    <div class="learn-sub">Then press the keyboard key you want to map to</div>
    <button class="btn btn-secondary cancel-btn" onclick="cancelLearn()">Cancel</button>
  </div>

  <!-- Mapping Editor Modal -->
  <div id="modalEditor" class="learn-overlay">
    <div class="card" style="width: 400px; padding: 24px; pointer-events: auto;">
      <h2 style="margin-bottom: 20px; font-size: 14px;">Edit Mapping</h2>
      <div style="display: flex; flex-direction: column; gap: 16px;">
        <div class="control-item">
          <label style="display:block; margin-bottom:6px; font-size:12px; color:var(--text-secondary);">Mapping
            Type</label>
          <select id="editMidiType"
            style="width:100%; padding:8px; background:var(--bg-input); border:1px solid var(--border-card); color:white; border-radius:6px;"
            onchange="toggleEditFields()">
            <option value="0">Note (Keypress)</option>
            <option value="1">CC (Slider/Knob)</option>
            <option value="2">Chord (Multi-Note)</option>
            <option value="3">Layer Key (HUD)</option>
            <option value="4">Macro (Text Sequence)</option>
            <option value="5">AI (Smart Prompt)</option>
          </select>
        </div>
        <div id="editFieldKey" class="control-item">
          <label style="display:block; margin-bottom:6px; font-size:12px; color:var(--text-secondary);">Key VK</label>
          <input type="number" id="editKeyVk"
            style="width:100%; padding:8px; background:var(--bg-input); border:1px solid var(--border-card); color:white; border-radius:6px;">
        </div>
        <div id="editFieldMacro" class="control-item" style="display:none;">
          <label style="display:block; margin-bottom:6px; font-size:12px; color:var(--text-secondary);">Macro
            Text</label>
          <textarea id="editMacroText"
            style="width:100%; height:80px; padding:8px; background:var(--bg-input); border:1px solid var(--border-card); color:white; border-radius:6px; font-family:inherit;"></textarea>
        </div>
        <div id="editFieldAi" class="control-item" style="display:none;">
          <label style="display:block; margin-bottom:6px; font-size:12px; color:var(--text-secondary);">AI Prompt
            Template</label>
          <textarea id="editAiPrompt"
            style="width:100%; height:80px; padding:8px; background:var(--bg-input); border:1px solid var(--border-card); color:white; border-radius:6px; font-family:inherit;"></textarea>
        </div>
        <div id="editFieldApp" class="control-item">
          <label style="display:block; margin-bottom:6px; font-size:12px; color:var(--text-secondary);">App Filter
            (e.g. chrome.exe)</label>
          <input type="text" id="editAppPattern" placeholder="Process name"
            style="width:100%; padding:8px; background:var(--bg-input); border:1px solid var(--border-card); color:white; border-radius:6px; font-family:inherit;">
        </div>
        <div id="editFieldTitle" class="control-item">
          <label style="display:block; margin-bottom:6px; font-size:12px; color:var(--text-secondary);">Window Title
            Filter (Pattern)</label>
          <input type="text" id="editTitlePattern" placeholder="e.g. index.html"
            style="width:100%; padding:8px; background:var(--bg-input); border:1px solid var(--border-card); color:white; border-radius:6px; font-family:inherit;">
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <button class="btn btn-primary" style="flex:1;" onclick="saveEdit()">Apply</button>
          <button class="btn btn-secondary" style="flex:1;" onclick="closeEditor()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // â”€â”€ Piano Roll Setup â”€â”€
    const pianoRoll = document.getElementById('pianoRoll');
    const TOTAL_KEYS = 128;
    const pianoKeys = [];

    // Build piano keys
    for (let i = 0; i < TOTAL_KEYS; i++) {
      const key = document.createElement('div');
      const n = i % 12;
      const isBlack = [1, 3, 6, 8, 10].includes(n);
      key.className = `piano-key ${isBlack ? 'black' : 'white'}`;
      key.dataset.note = i;
      pianoRoll.appendChild(key);
      pianoKeys.push(key);
    }

    // â”€â”€ State â”€â”€
    let logEntries = 0;
    let isLearning = false;
    let mappings = [];

    // â”€â”€ Send message to C++ backend â”€â”€
    function sendToBackend(action, data = {}) {
      if (window.chrome && window.chrome.webview) {
        window.chrome.webview.postMessage(JSON.stringify({ action, ...data }));
      }
    }

    // â”€â”€ Receive messages from C++ backend â”€â”€
    if (window.chrome && window.chrome.webview) {
      window.chrome.webview.addEventListener('message', (event) => {
        let msg;
        try {
          msg = (typeof event.data === 'string') ? JSON.parse(event.data) : event.data;
        } catch (e) {
          console.error("Message parse error:", e, event.data);
          return;
        }
        handleBackendMessage(msg);
      });
    }

    function toggleSettings() {
      const overlay = document.getElementById('settingsOverlay');
      overlay.classList.toggle('active');
    }

    function toggleHUD(active, title = "Default Layer") {
      const hud = document.getElementById('hudOverlay');
      const hudTitle = document.getElementById('hudTitle');
      hudTitle.innerText = title;
      if (active) {
        hud.classList.add('active');
        populateHUD();
      } else {
        hud.classList.remove('active');
      }
    }

    function populateHUD() {
      const grid = document.getElementById('hudGrid');
      grid.innerHTML = '';

      // Pull mapped items from current state
      mappings.slice(0, 12).forEach(m => {
        const item = document.createElement('div');
        item.className = 'hud-item';
        item.innerHTML = `
          <div class="hud-key-label">Note ${m.midi_num}</div>
          <div class="hud-action-label">${m.key_name}</div>
        `;
        grid.appendChild(item);
      });
    }

    function updateSettings() {
      const autoReconnect = document.getElementById('settingAutoReconnect').checked;
      const appSwitching = document.getElementById('settingAppSwitching').checked;
      const velocityZones = document.getElementById('settingVelocityZones').checked;
      const minimizeToTray = document.getElementById('settingMinimizeToTray').checked;
      const apiKey = document.getElementById('inputApiKey').value;
      const aiGlobal = document.getElementById('inputAiGlobal').value;
      sendToBackend('update_config', {
        auto_reconnect: autoReconnect,
        app_switching: appSwitching,
        velocity_zones: velocityZones,
        minimize_to_tray: minimizeToTray,
        ai_api_key: apiKey,
        ai_global_prompt: aiGlobal
      });
    }

    function handleBackendMessage(msg) {
      switch (msg.type) {
        case 'hud':
          toggleHUD(msg.active, msg.title);
          break;
        case 'config':
          if (msg.config) {
            document.getElementById('settingAutoReconnect').checked = msg.config.auto_reconnect;
            document.getElementById('settingAppSwitching').checked = msg.config.app_switching;
            if (msg.config.velocity_zones !== undefined) document.getElementById('settingVelocityZones').checked = msg.config.velocity_zones;
            if (msg.config.minimize_to_tray !== undefined) document.getElementById('settingMinimizeToTray').checked = msg.config.minimize_to_tray;
            if (msg.config.ai_api_key !== undefined) document.getElementById('inputApiKey').value = msg.config.ai_api_key;
            if (msg.config.ai_global_prompt !== undefined) document.getElementById('inputAiGlobal').value = msg.config.ai_global_prompt;
          }
          break;
        case 'ports':
          updatePorts(msg.ports);
          break;
        case 'connected':
          setConnected(true, msg.portName);
          break;
        case 'disconnected':
          setConnected(false);
          break;
        case 'log':
          addLog(msg.text, msg.category || 'system');
          break;
        case 'midi_note':
          activatePianoKey(msg.note, msg.velocity);
          addLog(`Note ${msg.note} (velocity: ${msg.velocity})`, 'midi-note');
          break;
        case 'midi_cc':
          addLog(`CC ${msg.cc} (value: ${msg.value})`, 'midi-cc');
          break;
        case 'mappings':
          updateMappings(msg.mappings);
          break;
        case 'learn_phase':
          updateLearnPhase(msg.phase, msg.text);
          break;
        case 'learn_done':
          endLearn();
          break;
        case 'status':
          setStatus(msg.text);
          break;
        case 'piano_decay':
          decayPianoKeys(msg.velocities);
          break;
        case 'run_ai':
          handleAiRequest(msg.prompt);
          break;
        case 'app_changed':
          // Update Context Band
          const band = document.getElementById('contextBand');
          const contextApp = document.getElementById('contextApp');
          const contextTitle = document.getElementById('contextTitle');

          band.style.display = 'flex';
          contextApp.textContent = msg.app || 'Unknown';
          contextTitle.textContent = msg.title || 'Untitled';

          // Also log for history
          addLog(`Context: ${msg.app} > ${msg.title}`, "system");
          break;
      }
    }

    async function handleAiRequest(prompt) {
      const apiKey = document.getElementById('inputApiKey').value;
      const mask = document.getElementById('inputAiGlobal').value;

      if (!apiKey) {
        addLog("AI Error: No API key provided in settings", "error");
        sendToBackend("status", { text: "AI Error: Mission API Key" });
        return;
      }

      const fullPrompt = mask.replace("{prompt}", prompt);

      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: "gpt-4-turbo-preview",
            messages: [{ role: "user", content: fullPrompt }],
            max_tokens: 150
          })
        });

        const data = await response.json();
        if (data.choices && data.choices[0]) {
          const result = data.choices[0].message.content.trim();
          addLog("AI Response: " + result, "system");
          sendToBackend("simulate_text", { text: result });
          sendToBackend("status", { text: "AI Typed success" });
        } else {
          throw new Error(data.error?.message || "Invalid API response");
        }
      } catch (e) {
        addLog("AI Request Failed: " + e.message, "error");
        sendToBackend("status", { text: "AI Failed" });
      }
    }

    // â”€â”€ UI Functions â”€â”€
    function updatePorts(ports) {
      const sel = document.getElementById('portSelect');
      sel.innerHTML = '';
      if (ports.length === 0) {
        sel.innerHTML = '<option value="">No MIDI ports found</option>';
        return;
      }
      ports.forEach((p, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = p;
        sel.appendChild(opt);
      });
    }

    function setConnected(connected, portName) {
      const dot = document.getElementById('statusDot');
      const label = document.getElementById('connectionLabel');
      const btn = document.getElementById('btnConnect');
      if (connected) {
        dot.classList.add('connected');
        label.textContent = portName || 'Connected';
        label.style.color = 'var(--green)';
        btn.textContent = 'Disconnect';
      } else {
        dot.classList.remove('connected');
        label.textContent = 'Disconnected';
        label.style.color = 'var(--text-tertiary)';
        btn.textContent = 'Connect';
      }
    }

    function addLog(text, category) {
      const body = document.getElementById('logBody');
      // Remove empty state
      const empty = body.querySelector('.empty-state');
      if (empty) empty.remove();

      const entry = document.createElement('div');
      entry.className = `log-entry ${category}`;
      const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
      entry.innerHTML = `<span class="timestamp">${time}</span>${escapeHtml(text)}`;
      body.appendChild(entry);
      body.scrollTop = body.scrollHeight;

      logEntries++;
      document.getElementById('logCount').textContent = logEntries;
    }

    function updateMappings(newMappings) {
      mappings = newMappings;
      const body = document.getElementById('mapBody');
      body.innerHTML = '';
      document.getElementById('mapCount').textContent = mappings.length;

      if (mappings.length === 0) {
        body.innerHTML = '<div class="empty-state"><div class="icon">ðŸ”—</div><span>Click <strong>Learn</strong> to create mappings</span></div>';
        return;
      }

      mappings.forEach((m, i) => {
        const item = document.createElement('div');
        item.className = 'mapping-item';

        let sourceText = (m.midi_type === 0 ? 'Note ' : (m.midi_type === 1 ? 'CC ' : (m.midi_type === 2 ? 'Chord ' : (m.midi_type === 4 ? 'Macro ' : (m.midi_type === 5 ? 'AI ' : 'Layer '))))) + m.midi_num;
        if (m.midi_type === 2) sourceText = "Chord [" + m.midi_chord.join(',') + "]";

        let targetText = m.target_display || 'Key';
        if (m.midi_type === 4) targetText = "Macro: " + (m.macro_text.substring(0, 15) + "...");
        if (m.midi_type === 5) targetText = "AI: " + (m.ai_prompt.substring(0, 15) + "...");

        if (m.title_pattern || m.app_pattern) {
          let contextLabel = ' [if:';
          if (m.app_pattern) contextLabel += ` ${m.app_pattern}`;
          if (m.title_pattern) contextLabel += ` ${m.app_pattern ? '& ' : ''}${m.title_pattern}`;
          contextLabel += ']';
          targetText += contextLabel;
        }

        let zoneBadge = '';
        if (m.vel_zone === 1) zoneBadge = '<span class="zone-badge soft">soft</span>';
        else if (m.vel_zone === 2) zoneBadge = '<span class="zone-badge hard">hard</span>';

        item.innerHTML = `
          <div style="display:flex;align-items:center; flex:1; cursor:pointer;" onclick="openEditor(${i})">
            <span class="source">${escapeHtml(sourceText)}</span>
            <span class="arrow">â†’</span>
            <span class="target">${escapeHtml(targetText)}</span>
            ${zoneBadge}
          </div>
          <div style="display:flex;gap:4px;">
            <button class="mini-btn" style="padding:2px 6px; font-size:10px; opacity:0.8;" onclick="openEditor(${i})">EDIT</button>
            <button class="delete-btn" onclick="deleteMapping(${i})">âœ•</button>
          </div>
        `;
        body.appendChild(item);
      });
    }

    function activatePianoKey(note, velocity) {
      if (note >= 0 && note < TOTAL_KEYS) {
        pianoKeys[note].classList.add('active');
        pianoKeys[note].style.boxShadow = `0 0 ${Math.min(velocity / 3, 20)}px var(--accent-glow), 0 0 4px var(--accent) inset`;
        setTimeout(() => {
          pianoKeys[note].classList.remove('active');
          pianoKeys[note].style.boxShadow = '';
        }, 300);
      }
    }

    function decayPianoKeys(velocities) {
      for (let i = 0; i < TOTAL_KEYS && i < velocities.length; i++) {
        if (velocities[i] > 0) {
          pianoKeys[i].classList.add('active');
          const intensity = velocities[i] / 127;
          pianoKeys[i].style.opacity = 0.3 + intensity * 0.7;
        } else {
          pianoKeys[i].classList.remove('active');
          pianoKeys[i].style.opacity = '';
        }
      }
    }

    function updateLearnPhase(phase, text) {
      document.getElementById('learnPrompt').textContent = text;
    }

    // â”€â”€ Actions â”€â”€
    function toggleConnect() {
      const sel = document.getElementById('portSelect');
      sendToBackend('toggle_connect', { port: parseInt(sel.value) || 0 });
    }

    function startLearn() {
      isLearning = true;
      document.getElementById('learnOverlay').classList.add('active');
      document.getElementById('btnLearn').classList.add('active');
      sendToBackend('start_learn');
    }

    function endLearn() {
      isLearning = false;
      document.getElementById('learnOverlay').classList.remove('active');
      document.getElementById('btnLearn').classList.remove('active');
    }

    function cancelLearn() {
      sendToBackend('cancel_learn');
      endLearn();
    }

    function deleteMapping(index) {
      sendToBackend('delete_mapping', { index });
    }

    function clearLog() {
      const body = document.getElementById('logBody');
      body.innerHTML = '<div class="empty-state"><div class="icon">ðŸŽ¹</div><span>Log cleared</span></div>';
      logEntries = 0;
      document.getElementById('logCount').textContent = '0';
      sendToBackend('clear_log');
    }

    function clearMappings() {
      sendToBackend('clear_mappings');
    }

    function addMapping() {
      sendToBackend('add_mapping');
    }

    function saveProfile() {
      sendToBackend('save_profile');
    }

    function loadProfile() {
      sendToBackend('load_profile');
    }

    function openSettings() {
      sendToBackend('open_settings');
    }

    function showAbout() {
      sendToBackend('show_about');
    }

    function setStatus(text) {
      document.getElementById('statusText').textContent = text;
    }

    let editingIndex = -1;
    function openEditor(index) {
      editingIndex = index;
      const m = mappings[index];
      document.getElementById('modalEditor').classList.add('active');
      document.getElementById('editMidiType').value = m.midi_type;
      document.getElementById('editKeyVk').value = m.key_vk;
      document.getElementById('editMacroText').value = m.macro_text || "";
      document.getElementById('editAiPrompt').value = m.ai_prompt || "";
      document.getElementById('editTitlePattern').value = m.title_pattern || "";
      document.getElementById('editAppPattern').value = m.app_pattern || "";
      toggleEditFields();
    }

    function toggleEditFields() {
      const type = document.getElementById('editMidiType').value;
      document.getElementById('editFieldKey').style.display = (type == 4 || type == 5) ? 'none' : 'block';
      document.getElementById('editFieldMacro').style.display = (type == 4) ? 'block' : 'none';
      document.getElementById('editFieldAi').style.display = (type == 5) ? 'block' : 'none';
    }

    function closeEditor() {
      document.getElementById('modalEditor').classList.remove('active');
    }

    function saveEdit() {
      if (editingIndex === -1) return;
      const type = parseInt(document.getElementById('editMidiType').value);
      const vk = parseInt(document.getElementById('editKeyVk').value);
      const macro = document.getElementById('editMacroText').value;
      const ai = document.getElementById('editAiPrompt').value;
      const title = document.getElementById('editTitlePattern').value;

      sendToBackend('update_mapping', {
        index: editingIndex,
        midi_type: type,
        key_vk: vk,
        macro_text: macro,
        ai_prompt: ai,
        title_pattern: title,
        app_pattern: document.getElementById('editAppPattern').value
      });
      closeEditor();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // â”€â”€ Keyboard handler for learning â”€â”€
    document.addEventListener('keydown', (e) => {
      if (isLearning) {
        // Ignore modifier-only keys
        if (['Control', 'Shift', 'Alt', 'Meta'].includes(e.key)) return;
        sendToBackend('learn_key', {
          key: e.key,
          keyCode: e.keyCode,
          ctrlKey: e.ctrlKey,
          shiftKey: e.shiftKey,
          altKey: e.altKey
        });
      }
    });

    function refreshPorts() {
      sendToBackend('scan_ports');
    }

    // Request initial data
    sendToBackend('init');
  </script>
</body>

</html>